ROSTemplateFormatVersion: '2015-09-01'
Description: Creates VPC ECS instance
Parameters:
  ImageId:
    Type: String
    Label: ECS Image Id
    Description: Image Id, represents the image resource to startup one ECS instance,
      <a href='#/product/cn-beijing/list/imageList' target='_blank'>View image resources</a>
    Default: centos_7
  InstanceType:
    Type: String
    Label: ECS Instance Type
    Description: The ECS instance type, <a href='#/product/cn-beijing/list/typeList'
      target='_blank'>View instance types</a>
    Default: ecs.c5.large
    AllowedValues:
    - ecs.c5.large
    - ecs.g5.large
    - ecs.c5.xlarge
    - ecs.g5.xlarge
  LoginPassword:
    Type: String
    Label: ECS Login Password
    Description: ECS Login Password
    AllowedPattern: '[a-zA-Z0-9-\(\)\`\~\!@\#\$%\^&\*-+=\|\{\}\[\]\:\;\â€˜\,\.\?\/]*'
    MinLength: 8
    MaxLength: 30
    NoEcho: true
    Confirm: true
  PublicIP:
    Type: Boolean
    Label: Allocate Public IP or Not
    Description: Allocate Public IP or Not
    Default: false
Resources:
  vpc:
    Type: ALIYUN::ECS::VPC
    Properties:
      CidrBlock: 192.168.0.0/16
      VpcName: myvpc
  vswitch:
    Type: ALIYUN::ECS::VSwitch
    Properties:
      ZoneId:
        Fn::Select:
        - '0'
        - Fn::GetAZs:
            Ref: ALIYUN::Region
      VpcId:
        Ref: vpc
      CidrBlock: 192.168.0.0/16
  sg:
    Type: ALIYUN::ECS::SecurityGroup
    Properties:
      VpcId:
        Ref: vpc
      SecurityGroupName: mysg
      SecurityGroupIngress:
      - PortRange: -1/-1
        Priority: 1
        SourceCidrIp: 0.0.0.0/0
        IpProtocol: all
        NicType: intranet
      SecurityGroupEgress:
      - PortRange: -1/-1
        Priority: 1
        IpProtocol: all
        DestCidrIp: 0.0.0.0/0
        NicType: intranet
  ecs:
    Type: ALIYUN::ECS::Instance
    Properties:
      VpcId:
        Ref: vpc
      VSwitchId:
        Ref: vswitch
      SecurityGroupId:
        Ref: sg
      ImageId:
        Ref: ImageId
      IoOptimized: optimized
      PrivateIpAddress: 192.168.0.1
      AllocatePublicIP:
        Ref: PublicIP
      InstanceType:
        Ref: InstanceType
      SystemDiskCategory: cloud_ssd
      Password:
        Ref: LoginPassword
Outputs:
  ecs_instance_id:
    Value:
      Fn::GetAtt:
      - ecs
      - InstanceId
