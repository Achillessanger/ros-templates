ROSTemplateFormatVersion: '2015-09-01'
Description:
  en: Use the private network connection service to share the private network SLB
    service deployed in a private VPC with another VPC using the same account.
  zh-cn: 用私网连接（PrivateLink）服务将一个专有网络（VPC）内部署的私网SLB服务共享给同账号下的另外一个VPC访问。
Parameters:
  ZoneId:
    Type: String
    Label:
      en: Availability Zone
      zh-cn: 可用区
    Description:
      zh-cn: 可用区ID，目前，仅部分地域支持私网连接。更多信息，请参见<a href='https://help.aliyun.com/document_detail/193819.html'><font
        color='red'><b>支持私网连接的地域和可用区</b></font></a>。
      en: Availability Zone Id,Currently, only some regions support private network
        connections. For more information,<a href='https://help.aliyun.com/document_detail/193819.html'
        target='_blank'><b><font color='red'>View region and zone info</font></b></a>.
    AssociationProperty: ALIYUN::ECS::Instance::ZoneId
  PrivateLinkClientName:
    Type: String
    Label:
      en: Client Name
      zh-cn: 客户端资源名称
    Description:
      en: Name of the client resource.
      zh-cn: 客户端资源名称
    Default: private_link_client
  PrivateLinkServerName:
    Type: String
    Label:
      en: Service Name
      zh-cn: 服务端资源名称
    Description:
      en: Name of the server resource.
      zh-cn: 服务端资源名称
    Default: private_link_service
  InstanceType:
    Type: String
    Label:
      en: Instance Type
      zh-cn: 实例类型
    Description:
      zh-cn: 填写VSwitch可用区下可使用的规格；<br>通用规格：<font color='red'><b>ecs.c5.large</b></font><br>注：可用区可能不支持通用规格<br>规格详见：<a
        href='https://help.aliyun.com/document_detail/25378.html' target='_blank'><b><font
        color='blue'>实例规格族</font></a></b>
      en: 'Fill in specifications that can be used under the VSwitch availability
        zone;</b></font><br>general specifications：<font color=''red''><b>ecs.c5.large</b></font><br>note:
        a few zones do not support general specifications<br>see detail: <a href=''https://www.alibabacloud.com/help/en/doc-detail/25378.html''
        target=''_blank''><b><font color=''blue''>Instance Specification Family</font></a></b>'
    AssociationProperty: ALIYUN::ECS::Instance::InstanceType
    AssociationPropertyMetadata:
      ZoneId: ${ZoneId}
  SystemDiskCategory:
    Type: String
    Label:
      en: System Disk Category
      zh-cn: 系统盘类型
    Description:
      en: '<font color=''blue''><b>Optional values:</b></font><br>[cloud_efficiency:
        <font color=''green''>Efficient Cloud Disk</font>]<br>[cloud_ssd: <font color=''green''>SSD
        Cloud Disk</font>]<br>[cloud_essd: <font color=''green''>ESSD Cloud Disk</font>]<br>[cloud:
        <font color=''green''>Cloud Disk</font>]<br>[ephemeral_ssd: <font color=''green''>Local
        SSD Cloud Disk</font>]'
      zh-cn: '<font color=''blue''><b>可选值：</b></font><br>[cloud_efficiency: <font
        color=''green''>高效云盘</font>]<br>[cloud_ssd: <font color=''green''>SSD云盘</font>]<br>[cloud_essd:
        <font color=''green''>ESSD云盘</font>]<br>[cloud: <font color=''green''>普通云盘</font>]<br>[ephemeral_ssd:
        <font color=''green''>本地SSD盘</font>]'
    AssociationProperty: ALIYUN::ECS::Disk::DataDiskCategory
    AssociationPropertyMetadata:
      ZoneId: ${ZoneId}
      InstanceType: ${InstanceType}
  Password:
    Type: String
    Label:
      en: Instance Password
      zh-cn: 实例密码
    Description:
      en: Server login password, Length 8-30, must contain three(Capital letters,
        lowercase letters, numbers, ()`~!@#$%^&*_-+=|{}[]:;'<>,.?/ Special symbol
        in).
      zh-cn: 服务器登录密码,长度8-30，必须包含三项（大写字母、小写字母、数字、 ()`~!@#$%^&*_-+=|{}[]:;'<>,.?/ 中的特殊符号）。
    ConstraintDescription:
      en: Length 8-30, must contain three(Capital letters, lowercase letters, numbers,
        ()`~!@#$%^&*_-+=|{}[]:;'<>,.?/ Special symbol in).
      zh-cn: 长度8-30，必须包含三项（大写字母、小写字母、数字、 ()`~!@#$%^&*_-+=|{}[]:;'<>,.?/ 中的特殊符号）。
    AllowedPattern: '[0-9A-Za-z\_\-\&:;''<>,=%`~!@#\(\)\$\^\*\+\|\{\}\[\]\.\?\/]+$'
    MinLength: 8
    MaxLength: 30
    NoEcho: true
Resources:
  ClientVpc:
    Type: ALIYUN::ECS::VPC
    Properties:
      CidrBlock: 192.168.0.0/16
      VpcName:
        Ref: PrivateLinkClientName
  ServerVpc:
    Type: ALIYUN::ECS::VPC
    Properties:
      CidrBlock: 192.168.0.0/16
      VpcName:
        Ref: PrivateLinkServerName
  ClientVsw:
    Type: ALIYUN::ECS::VSwitch
    Properties:
      ZoneId:
        Ref: ZoneId
      VpcId:
        Ref: ClientVpc
      VSwitchName:
        Ref: PrivateLinkClientName
      CidrBlock: 192.168.1.0/24
  ServerVsw:
    Type: ALIYUN::ECS::VSwitch
    Properties:
      ZoneId:
        Ref: ZoneId
      VpcId:
        Ref: ServerVpc
      VSwitchName:
        Ref: PrivateLinkClientName
      CidrBlock: 192.168.2.0/24
  ClientSecurityGroup:
    Type: ALIYUN::ECS::SecurityGroup
    Properties:
      VpcId:
        Ref: ClientVpc
      SecurityGroupName:
        Ref: PrivateLinkClientName
      SecurityGroupIngress:
      - Policy: accept
        PortRange: -1/-1
        IpProtocol: all
        NicType: intranet
        SourceCidrIp: 0.0.0.0/0
        Priority: 1
      SecurityGroupEgress:
      - Policy: accept
        PortRange: -1/-1
        IpProtocol: all
        NicType: intranet
        Priority: 1
        DestCidrIp: 0.0.0.0/0
  ServerSecurityGroup:
    Type: ALIYUN::ECS::SecurityGroup
    Properties:
      VpcId:
        Ref: ServerVpc
      SecurityGroupName:
        Ref: PrivateLinkServerName
      SecurityGroupIngress:
      - Policy: accept
        PortRange: -1/-1
        IpProtocol: all
        NicType: intranet
        SourceCidrIp: 0.0.0.0/0
        Priority: 1
      SecurityGroupEgress:
      - Policy: accept
        PortRange: -1/-1
        IpProtocol: all
        NicType: intranet
        Priority: 1
        DestCidrIp: 0.0.0.0/0
  ClientEcs:
    Type: ALIYUN::ECS::InstanceGroup
    Properties:
      ZoneId:
        Ref: ZoneId
      VpcId:
        Ref: ClientVpc
      VSwitchId:
        Ref: ClientVsw
      SecurityGroupId:
        Ref: ClientSecurityGroup
      ImageId: win2016_1607_x64_dtc_zh-cn_40G_alibase_20211115.vhd
      MaxAmount: 1
      InstanceType:
        Ref: InstanceType
      InstanceName:
        Ref: PrivateLinkClientName
      Password:
        Ref: Password
      IoOptimized: optimized
      SystemDiskCategory:
        Ref: SystemDiskCategory
      NetworkType: vpc
      AllocatePublicIP: true
      InternetMaxBandwidthOut: 5
  WebServerConditionHandle:
    Type: ALIYUN::ROS::WaitConditionHandle
    Properties: {}
  ServerEcs:
    Type: ALIYUN::ECS::InstanceGroup
    Properties:
      ZoneId:
        Ref: ZoneId
      VpcId:
        Ref: ServerVpc
      VSwitchId:
        Ref: ServerVsw
      SecurityGroupId:
        Ref: ServerSecurityGroup
      ImageId: Centos_7
      MaxAmount: 2
      InstanceType:
        Ref: InstanceType
      InstanceName:
        Ref: PrivateLinkServerName
      Password:
        Ref: Password
      IoOptimized: optimized
      SystemDiskCategory:
        Ref: SystemDiskCategory
      NetworkType: vpc
      InternetMaxBandwidthOut: 0
      UserData:
        Fn::Join:
        - '

          '
        - - '#!/bin/bash'
          - yum install -y nginx
          - mkdir -p /data/nginx
          - echo "Hello World! This is service client ecs." > /data/nginx/index.html
          - cat > /etc/nginx/conf.d/server.conf <<EOF
          - server {
          - '    listen 80;'
          - '    server_name _;'
          - '    index index.html;'
          - '    root /data/nginx;'
          - '}'
          - EOF
          - systemctl stop nginx
          - systemctl start nginx
          - systemctl enable nginx
          - Fn::Sub: '${WebServerConditionHandle.CurlCli} -d ''{"data" : "Install
              nginx web."}'''
  WebServerWaitCondition:
    Type: ALIYUN::ROS::WaitCondition
    Properties:
      Timeout: 1800
      Count: 2
      Handle:
        Ref: WebServerConditionHandle
    DependsOn: ServerEcs
  SLB:
    Type: ALIYUN::SLB::LoadBalancer
    Properties:
      VpcId:
        Ref: ServerVpc
      VSwitchId:
        Ref: ServerVsw
      AddressType: intranet
      LoadBalancerName:
        Ref: PrivateLinkServerName
      MasterZoneId:
        Ref: ZoneId
      LoadBalancerSpec: slb.s1.small
      PayType: PayOnDemand
  VServerGroup:
    Type: ALIYUN::SLB::VServerGroup
    Properties:
      VServerGroupName:
        Ref: PrivateLinkServerName
      BackendServers:
      - ServerId:
          Fn::Select:
          - '0'
          - Fn::GetAtt:
            - ServerEcs
            - InstanceIds
        Port: '80'
      - ServerId:
          Fn::Select:
          - '1'
          - Fn::GetAtt:
            - ServerEcs
            - InstanceIds
        Port: '80'
      LoadBalancerId:
        Ref: SLB
  SlbListener:
    Type: ALIYUN::SLB::Listener
    Properties:
      Protocol: tcp
      ListenerPort: '80'
      Bandwidth: -1
      BackendServerPort: 80
      LoadBalancerId:
        Ref: SLB
      VServerGroupId:
        Ref: VServerGroup
  VpcEndpointService:
    Type: ALIYUN::PrivateLink::VpcEndpointService
    Properties:
      ServiceDescription:
        Ref: PrivateLinkServerName
      Resource:
      - ZoneId:
          Ref: ZoneId
        ResourceId:
          Ref: SLB
        ResourceType: slb
      AutoAcceptEnabled: true
  VpcEndpoint:
    Type: ALIYUN::PrivateLink::VpcEndpoint
    Properties:
      VpcId:
        Ref: ClientVpc
      SecurityGroupId:
      - Ref: ClientSecurityGroup
      EndpointName:
        Ref: PrivateLinkClientName
      ServiceId:
        Ref: VpcEndpointService
      Zone:
      - ZoneId:
          Ref: ZoneId
        VSwitchId:
          Ref: ClientVsw
Outputs:
  VpcEndpointDomain:
    Value:
      Fn::GetAtt:
      - VpcEndpoint
      - EndpointDomain
  ClientIP:
    Value:
      Fn::Select:
      - '0'
      - Fn::GetAtt:
        - ClientEcs
        - PublicIps
Metadata:
  ALIYUN::ROS::Interface:
    ParameterGroups:
    - Parameters:
      - ZoneId
      - PrivateLinkClientName
      - PrivateLinkServerName
      Label:
        default:
          en: Basic Configuration
          zh-cn: 基础配置
    - Parameters:
      - InstanceType
      - SystemDiskCategory
      - Password
      Label:
        default:
          en: ECS Instance
          zh-cn: ECS实例参数
    TemplateTags:
    - acs:example:网络:创建同账号VPC间的私网访问服务
