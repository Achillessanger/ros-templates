ROSTemplateFormatVersion: '2015-09-01'
Description:
  en: Deploy cube game using ACK.
  zh-cn: 使用ACK部署魔方游戏。
Parameters:
  AckName:
    Type: String
    Label:
      en: Cluster Name
      zh-cn: 集群名称
    Description:
      en: The name must be 1 to 63 characters in length and can contain letters, Chinese
        characters, digits, and hyphens (-).
      zh-cn: 名称为1~63个字符，可包含数字、汉字、英文字符或中划线（-）。
    Default: ack-demo
    AllowedPattern: ^[a-zA-Z0-9\u4e00-\u9fa5][-a-zA-Z0-9\u4e00-\u9fa5]{0,62}$
  ZoneId:
    Type: String
    Label:
      en: VSwitch Available Zone
      zh-cn: 可用区
    AssociationProperty: ALIYUN::VPC::Zone::ZoneId
  InstanceType:
    Type: String
    Label:
      en: Instance Type
      zh-cn: 节点规格
    AssociationProperty: ALIYUN::ECS::Instance::InstanceType
    AssociationPropertyMetadata:
      ZoneId: ${ZoneId}
    AllowedPattern: ^(ecs\.[a-z5-9]+\.)[1-9]?xlarge$
  SystemDiskCategory:
    Type: String
    Label:
      en: Worker System Disk Category
      zh-cn: 节点系统盘磁盘类型
  LoginPassword:
    Type: String
    Label:
      en: Instance Password
      zh-cn: 节点登录密码
    Description:
      en: |-
        The password must be 8 to 32 characters in length. <br>
        It must consist three of the the following character types: uppercase letters, lowercase letters, digits, and special characters. <br>
        Special characters include <span style="background:#E7E9EB;"><b>()`~!@#$%^&*_-+=|{}[]:;'<>,.?/</b></span>.<br>
      zh-cn: 长度为8-30位，需包含大写字母、小写字母、特殊符号和数字中的三个，允许的特殊字符包括<span style="background:#E7E9EB;"><b>()`~!@#$%^&*_-+=|{}[]:;'<>,.?/</b></span>。
    AssociationProperty: ALIYUN::ECS::Instance::Password
Resources:
  EnableAck:
    Type: ALIYUN::ROS::AutoEnableService
    Properties:
      ServiceName: CS
  Vpc:
    Type: ALIYUN::ECS::VPC
    Properties:
      CidrBlock: 192.168.0.0/16
  Vswitch:
    Type: ALIYUN::ECS::VSwitch
    Properties:
      ZoneId:
        Ref: ZoneId
      VpcId:
        Ref: Vpc
      CidrBlock: 192.168.0.0/24
  NatGateway:
    Type: ALIYUN::VPC::NatGateway
    Properties:
      ZoneId:
        Ref: ZoneId
      VpcId:
        Ref: Vpc
      VSwitchId:
        Ref: Vswitch
  Ack:
    Type: ALIYUN::CS::ManagedKubernetesCluster
    Properties:
      VpcId:
        Ref: Vpc
      VSwitchIds:
      - Ref: Vswitch
      PodVswitchIds:
      - Ref: Vswitch
      Name:
        Ref: AckName
      NumOfNodes: 2
      ClusterSpec: ack.pro.small
      ServiceCidr: 172.16.0.0/16
      Addons:
      - Name: security-inspector
      - Name: terway-eniip
        Config: '{"IPVlan":"false","NetworkPolicy":"false","ENITrunking":"false"}'
      - Name: csi-plugin
      - Name: csi-provisioner
      - Name: storage-operator
        Config: '{"CnfsOssEnable":"false","CnfsNasEnable":"false"}'
      - Name: logtail-ds
        Config: '{"IngressDashboardEnabled":"true"}'
      - Name: ack-node-problem-detector
        Config: '{"sls_project_name":""}'
      - Name: nginx-ingress-controller
        Config: '{"IngressSlbNetworkType":"internet","IngressSlbSpec":"slb.s2.small"}'
      - Name: ack-node-local-dns
      - Name: arms-prometheus
      EndpointPublicAccess: true
      SnatEntry: true
      IsEnterpriseSecurityGroup: true
      WorkerInstanceTypes:
      - Ref: InstanceType
      WorkerSystemDiskCategory:
        Ref: SystemDiskCategory
      WorkerSystemDiskSize: 120
      LoginPassword:
        Ref: LoginPassword
      Runtime:
        Name: containerd
        Version: 1.6.20
    DependsOn:
    - NatGateway
    - EnableAck
  AckCubeApplication:
    Type: ALIYUN::CS::ClusterApplication
    Properties:
      ClusterId:
        Ref: Ack
      YamlContent: |-
        apiVersion: apps/v1
        kind: Deployment
        metadata:
          name: ack-cube
          labels:
            app: ack-cube
          annotations: {}
        spec:
          replicas: 2
          selector:
            matchLabels:
              app: ack-cube
          template:
            metadata:
              labels:
                app: ack-cube
              annotations: {}
            spec:
              containers:
                - name: ack-cube
                  image: registry.cn-hangzhou.aliyuncs.com/acr-toolkit/ack-cube:1.0
                  resources:
                    limits:
                      cpu: '1'
                      memory: 1024Mi
                    requests:
                      cpu: '0.5'
                      memory: 512Mi
                  volumeMounts: []
                  ports:
                    - protocol: TCP
                      containerPort: 80
                      name: ack
        ---
        apiVersion: v1
        kind: Service
        metadata:
          name: ack-cube-svc
          namespace: ''
          annotations:
            service.beta.kubernetes.io/alibaba-cloud-loadbalancer-spec: slb.s1.small
        spec:
          selector:
            app: ack-cube
          ports:
            - protocol: TCP
              port: 80
              targetPort: 80
          type: LoadBalancer
          externalTrafficPolicy: Local
  KubeAddress:
    Type: DATASOURCE::CS::ClusterApplicationResources
    Properties:
      ClusterId:
        Ref: Ack
      Kind: Service
      Name: ack-cube-svc
      JsonPath: $.status.loadBalancer.ingress.[0].ip
      FirstMatch: true
    DependsOn: AckCubeApplication
Outputs:
  CubeAddress:
    Description:
      en: Cube game access address.
      zh-cn: 魔方游戏访问地址。
    Value:
      Fn::Sub: http://${KubeAddress}
  AckClusterId:
    Description:
      en: Ack cluster id.
      zh-cn: Ack集群id。
    Value:
      Ref: Ack
Metadata:
  ALIYUN::ROS::Interface:
    ParameterGroups:
    - Parameters:
      - AckName
      - ZoneId
      - InstanceType
      - SystemDiskCategory
      - LoginPassword
    TemplateTags:
    - acs:document-help:ack:使用ACK部署魔方游戏
