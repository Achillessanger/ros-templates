ROSTemplateFormatVersion: '2015-09-01'
Description:
  zh-cn: 中小型公司交易系统数据零丢失最佳实践 - 云上环境部署
  en: Best Practices for Zero Loss of Data in Small and Medium-sized Company Trading
    Systems - Environment Deployment on the Cloud
Parameters:
  CidrBlock:
    Type: String
    Label:
      en: VPC CIDR Block
      zh-cn: 专有网络网段
    Description:
      en: 'The IP address range of the VPC in the CIDR Block form, you can use the
        following IP address ranges: <br><font color=''green''>[10.0.0.0/8]</font><br><font
        color=''green''>[172.16.0.0/12]</font><br><font color=''green''>[192.168.0.0/16]</font>'
      zh-cn: 专有网络IP地址段范围，您可以使用以下的IP地址段:<br><font color='green'>[10.0.0.0/8]</font><br><font
        color='green'>[172.16.0.0/12]</font><br><font color='green'>[192.168.0.0/16]</font>
    Default: 192.168.0.0/16
    AllowedValues:
    - 10.0.0.0/8
    - 172.16.0.0/12
    - 192.168.0.0/16
  VswCidrBlock:
    Type: String
    Label:
      en: VSwitch CIDR Block
      zh-cn: 交换机网段
    Description:
      zh-cn: 必须是所属专有网络的子网段，并且没有被其他交换机占用。
      en: Must be a subnet segment that belongs to a proprietary network and is not
        occupied by another VSwitch.
    Default: 192.168.0.0/24
  ZoneId:
    Type: String
    Label:
      en: Available Zone
      zh-cn: 可用区
    Description:
      en: Availability Zone ID,<br><b>note： <font color='blue'>Before selecting, please
        confirm that the Availability Zone supports the specification of creating
        ECS、RDS、SLB resources</font></b>
      zh-cn: 可用区ID。<br><b>注： <font color='blue'>选择可用区前请确认该可用区是否支持创建ECS、RDS、SLB资源的规格</font></b>
    AssociationProperty: ALIYUN::ECS::Instance:ZoneId
  ImageId:
    Type: String
    Label:
      en: Image
      zh-cn: 镜像
    Description:
      en: 'Server instance Image ID. see detail: <b><a href=''https://www.alibabacloud.com/help/doc-detail/112977.html''
        target=''_blank''><font color=''blue''>Find the mirror</font></a></b>'
      zh-cn: 服务器镜像，详见：<b><a href='https://help.aliyun.com/document_detail/112977.html'
        target='_blank'><font color='blue'>查找镜像</font></a></b>
    AssociationProperty: ALIYUN::ECS::Instance:ImageId
    Default: centos_7_06_64_20G_alibase_20190711.vhd
  InstanceType:
    Type: String
    Label:
      en: Specifications
      zh-cn: 规格
    Description:
      zh-cn: 填写VSwitch可用区下可使用的规格；<br>通用规格：<font color='red'><b>ecs.c5.large</b></font><br>注：可用区可能不支持通用规格<br>规格详见：<a
        href='https://help.aliyun.com/document_detail/25378.html' target='_blank'><b><font
        color='blue'>实例规格族</font></a></b>
      en: 'Fill in specifications that can be used under the VSwitch availability
        zone;</b></font><br>general specifications：<font color=''red''><b>ecs.c5.large</b></font><br>note:
        a few zones do not support general specifications<br>see detail: <a href=''https://www.alibabacloud.com/help/en/doc-detail/25378.html''
        target=''_blank''><b><font color=''blue''>Instance Specification Family</font></a></b>'
    AssociationProperty: ALIYUN::ECS::Instance::InstanceType
    AssociationPropertyMetadata:
      ZoneId: ZoneId
  LoginPassword:
    Type: String
    Label:
      en: Login Password
      zh-cn: 登录密码
    Description:
      en: Server login password, Length 8-30, must contain three(Capital letters,
        lowercase letters, numbers, ()`~!@#$%^&*_-+=| {}[]:;' <>,.? / Special symbol
        in).
      zh-cn: 服务器登录密码,长度8-30，必须包含三项（大写字母、小写字母、数字、 ()`~!@#$%^&*_-+=|{}[]:;'<>,.?/ 中的特殊符号）。
    ConstraintDescription:
      en: Server login password, Length 8-30, must contain three(Capital letters,
        lowercase letters, numbers, ()`~!@#$%^&*_-+=| {}[]:;' <>,.? / Special symbol
        in).
      zh-cn: 服务器登录密码,长度8-30，必须包含三项（大写字母、小写字母、数字、 ()`~!@#$%^&*_-+=|{}[]:;'<>,.?/ 中的特殊符号）。
    AllowedPattern: '[0-9A-Za-z\_\-\&:;''<>,=%`~!@#\(\)\$\^\*\+\|\{\}\[\]\.\?\/]+$'
    MinLength: 8
    MaxLength: 30
    NoEcho: true
  ECSAmount:
    Type: Number
    Label:
      zh-cn: ECS实例数量
      en: ECS Amount
    Description:
      zh-cn: 取值范围：1~100
      en: 'Amount of ECS, Valid values: 1~100.'
    ConstraintDescription:
      zh-cn: 取值范围：1~100
      en: 'Amount of ECS, Valid values: 1~100.'
    Default: 3
    MinValue: 1
    MaxValue: 100
  DiskSize:
    Type: Number
    Label:
      zh-cn: 数据盘空间
      en: Data Disk Size
    Description:
      zh-cn: 数据盘大小，取值范围：40~500，单位：GB。
      en: 'Data disk size, Valid values: 40~500, unit: GB.  '
    ConstraintDescription:
      zh-cn: 数据盘大小，取值范围：40~500，单位：GB。
      en: 'Data disk size, Valid values: 40~500, unit: GB.  '
    Default: 40
    MinValue: 40
    MaxValue: 500
  DiskCategory:
    Type: String
    Label:
      zh-cn: 数据盘类型
      en: Data Disk Type
    Description:
      en: '<font color=''blue''><b>Optional values:</b></font><br>[cloud_efficiency:
        <font color=''green''>Efficient Cloud Disk</font>]<br>[cloud_ssd: <font color=''green''>SSD
        Cloud Disk</font>]<br>[cloud_essd: <font color=''green''>ESSD Cloud Disk</font>]<br>[cloud:
        <font color=''green''>Cloud Disk</font>]<br>[ephemeral_ssd: <font color=''green''>Local
        SSD Cloud Disk</font>]'
      zh-cn: '<font color=''blue''><b>可选值：</b></font><br>[cloud_efficiency: <font
        color=''green''>高效云盘</font>]<br>[cloud_ssd: <font color=''green''>SSD云盘</font>]<br>[cloud_essd:
        <font color=''green''>ESSD云盘</font>]<br>[cloud: <font color=''green''>普通云盘</font>]<br>[ephemeral_ssd:
        <font color=''green''>本地SSD盘</font>]'
    Default: cloud_efficiency
    AllowedValues:
    - cloud_efficiency
    - cloud_ssd
    - cloud
    - cloud_essd
    - ephemeral_ssd
  SystemDiskSize:
    Type: Number
    Label:
      zh-cn: 系统盘空间
      en: System Disk Size
    Description:
      zh-cn: 系统盘大小，取值范围：40~500。单位：GB
      en: 'System disk size, Valid values: 40~500. Unit: GB'
    ConstraintDescription:
      zh-cn: 系统盘大小，取值范围：40~500。单位：GB
      en: 'System disk size, Valid values: 40~500. Unit: GB'
    Default: 40
    MinValue: 20
    MaxValue: 500
  SystemDiskCategory:
    Type: String
    Label:
      en: System Disk Type
      zh-cn: 系统盘类型
    Description:
      en: '<font color=''blue''><b>Optional values:</b></font><br>[cloud_efficiency:
        <font color=''green''>Efficient Cloud Disk</font>]<br>[cloud_ssd: <font color=''green''>SSD
        Cloud Disk</font>]<br>[cloud_essd: <font color=''green''>ESSD Cloud Disk</font>]<br>[cloud:
        <font color=''green''>Cloud Disk</font>]<br>[ephemeral_ssd: <font color=''green''>Local
        SSD Cloud Disk</font>]'
      zh-cn: '<font color=''blue''><b>可选值：</b></font><br>[cloud_efficiency: <font
        color=''green''>高效云盘</font>]<br>[cloud_ssd: <font color=''green''>SSD云盘</font>]<br>[cloud_essd:
        <font color=''green''>ESSD云盘</font>]<br>[cloud: <font color=''green''>普通云盘</font>]<br>[ephemeral_ssd:
        <font color=''green''>本地SSD盘</font>]'
    Default: cloud_ssd
    AllowedValues:
    - cloud_efficiency
    - cloud_ssd
    - cloud
    - cloud_essd
    - ephemeral_ssd
  InstanceNamePrefix:
    Type: String
    Label:
      zh-cn: 实例名称
      en: Instance Name
    Description:
      zh-cn: 2-125个字符，以大小写英文或中文开头，可包含数字、下划线（_）、点（.）或连字符（-）。
      en: 2-125 characters, beginning with upper or lower case English or Chinese,
        may contain Numbers, underscores (_), dots (.), or hyphens (-).
    ConstraintDescription:
      zh-cn: 2-125个字符，以大小写英文或中文开头，可包含数字、下划线（_）、点（.）或连字符（-）。
      en: 2-125 characters, beginning with upper or lower case English or Chinese,
        may contain Numbers, underscores (_), dots (.), or hyphens (-).
    Default: App
    MinLength: 2
    MaxLength: 125
  HostNamePrefix:
    Type: String
    Label:
      zh-cn: 主机名
      en: Host Name
    Description:
      zh-cn: 2-61个字符，以大小写英文或中文开头，可包含数字、下划线（_）、点（.）或连字符（-）。
      en: 2-61 characters, beginning with upper or lower case English or Chinese,
        may contain Numbers, underscores (_), dots (.), or hyphens (-).
    ConstraintDescription:
      zh-cn: 2-61个字符，以大小写英文或中文开头，可包含数字、下划线（_）、点（.）或连字符（-）。
      en: 2-61 characters, beginning with upper or lower case English or Chinese,
        may contain Numbers, underscores (_), dots (.), or hyphens (-).
    Default: App
    MinLength: 2
    MaxLength: 61
  PayType:
    Type: String
    Label:
      zh-cn: 付费方式
      en: Pay Type
    Description:
      en: Pay type of SLB.
      zh-cn: SLB实例的计费类型。
    Default: PayOnDemand
    AllowedValues:
    - PayOnDemand
    - PrePay
  AddressType:
    Type: String
    Label:
      zh-cn: 负载均衡地址类型
      en: SLB Address Type
    Description:
      en: AddressType of SLB
      zh-cn: 负载均衡地址类型
    Default: internet
    AllowedValues:
    - internet
    - intranet
  SLB_InternetChargeType:
    Type: String
    Label:
      zh-cn: 公网类型实例付费方式
      en: Internet ChargeType
    Description:
      zh-cn: '可选值：<br>[paybybandwidth: <font color=''green''>按固定带宽计费</font>]<br>[paybytraffic：<font
        color=''green''>按使用流量计费</font>]'
      en: ' Allowed Values: <br>[paybybandwidth: <font color=''green''>pay by bandwidth</font>]<br>[paybytraffic:
        <font color=''green''>pay by traffic</font>]'
    Default: paybytraffic
    AllowedValues:
    - paybybandwidth
    - paybytraffic
  LoadBalancerSpec:
    Type: String
    Label:
      zh-cn: 规格
      en: Specifications
    Description:
      zh-cn: 负载均衡实例的规格，详情请参见<a href='https://help.aliyun.com/document_detail/85931.html'
        target='_blank'>实例概述<a>。
      en: Specification for SLB, for more info, please refer to <a href='https://www.alibabacloud.com/help/doc-detail/85931.htm'
        target='_blank'>SLB Instance Overview<a>.
    Default: slb.s2.medium
  LoadBalancerName:
    Type: String
    Label:
      zh-cn: 负载均衡名称
      en: SLB Name
    Description:
      zh-cn: 负载均衡实例的名称，长度为1~80个字符，可以包含下划线。
      en: SLB Name, contains of 1 to 80 characters, can contains underlines.
    ConstraintDescription:
      zh-cn: 负载均衡实例的名称，长度为1~80个字符，可以包含下划线。
      en: SLB Name, contains of 1 to 80 characters, can contains underlines.
    Default: SLB_HZ_APP01
    MinLength: 1
    MaxLength: 80
  Protocol:
    Type: String
    Label:
      zh-cn: 负载均衡协议
      en: SLB IP Protocol
    Description:
      en: IP Protocol
      zh-cn: IP协议
    Default: tcp
    AllowedValues:
    - tcp
    - udp
    - http
    - https
  ListenerPort:
    Type: Number
    Label:
      zh-cn: 监听端口
      en: Listener Port
    Description:
      zh-cn: 负载均衡监听端口，可选值：1~65535
      en: 'Port of SLB Listening to, Value range: 1~65535.'
    ConstraintDescription:
      zh-cn: 负载均衡监听端口，可选值：1~65535
      en: 'Port of SLB Listening to, Valid values: 1~65535.'
    Default: 80
    MinValue: 1
    MaxValue: 65535
  SLBBackendServerPort:
    Type: Number
    Label:
      zh-cn: 负载均衡对外服务的端口
      en: SLB Backend Server Port
    Description:
      zh-cn: 负载均衡实例后端使用的端口，可选值：1-65535。
      en: 'The ports used at the back end of the load balancing instance, Valid values:
        1~65535.'
    ConstraintDescription:
      zh-cn: 负载均衡实例后端使用的端口，可选值：1-65535。
      en: 'The ports used at the back end of the load balancing instance, Valid values:
        1~65535.'
    Default: 80
    MinValue: 1
    MaxValue: 65535
  DBInstanceEngineAndVersion:
    Type: String
    Label:
      zh-cn: 类型与版本号
      en: DB Type and Version
    Description:
      zh-cn: 数据库类型与版本号。
      en: Database type and version number.
    Default: MySQL-5.6
    AllowedValues:
    - MySQL-5.5
    - MySQL-5.6
    - MySQL-5.7
    - MySQL-8.0
  DBInstanceClass:
    Type: String
    Label:
      zh-cn: 规格
      en: Specifications
    Description:
      zh-cn: 填写前请先确认该机型在该可用区下的库存情况，并且需要确认是否支持创建三节点企业版的实例; <br>详见：<a href='https://help.aliyun.com/document_detail/26312.html'
        target='_blank'><b><font color='blue'>实例规格表</font></b></a>.
      en: Before filling in the form, please first confirm the inventory status of
        the model under the available area and confirm whether it supports the creation
        of an instance of the Enterprise Edition.For more infomation, please refer
        to <a href='https://www.alibabacloud.com/help/doc-detail/26312.htm' target='_blank'><b><font
        color='blue'>Primary instance types</font></b></a>.
    Default: rds.mysql.s3.large
  DBInstanceStorage:
    Type: Number
    Label:
      zh-cn: 存储空间
      en: DB Instance Storage
    Description:
      zh-cn: 数据库存储空间, 单位：GB, 每5GB进行递增，取值范围：50-1000。
      en: 'Database storage space, unit: GB, increasing every 5GB, valid value: 50-1000.'
    ConstraintDescription:
      zh-cn: 数据库存储空间, 单位：GB, 每5GB进行递增，取值范围：50-1000。
      en: 'Database storage space, unit: GB, increasing every 5GB, valid value: 50-1000.'
    Default: 50
    MinValue: 50
    MaxValue: 1000
  DBName:
    Type: String
    Label:
      zh-cn: 数据库名称
      en: DB Name
    Description:
      zh-cn: 数据库名称，由小写字母、数字及特殊字符（-_）组成，以字母开头，字母或数字结尾，最多64个字符。
      en: Database name, consisting of lowercase letters, Numbers, and special characters
        (-_), starting with letters, ending with letters or Numbers, up to 64 characters.
    Default: demodb
  RdsUserName:
    Type: String
    Label:
      zh-cn: 数据库账号
      en: RDS Account
    Description:
      zh-cn: 由小写字母，数字、下划线组成，以字母开头，字母或数字结尾，最多16个字符，最少2个字符。
      en: Consists of lowercase letters, Numbers, and underscores, beginning with
        letters, ending with letters or Numbers, up to 16 characters, and at least
        2 characters.
    ConstraintDescription:
      zh-cn: 由小写字母，数字、下划线组成，以字母开头，字母或数字结尾，最多16个字符，最少2个字符。
      en: Consists of lowercase letters, Numbers, and underscores, beginning with
        letters, ending with letters or Numbers, up to 16 characters, and at least
        2 characters.
    Default: admin_dba
    MinLength: 2
    MaxLength: 16
  RdsUserType:
    Type: String
    Label:
      zh-cn: 账号类型
      en: RDS Account Type
    Description:
      zh-cn: '数据库账号类型，<b><font color=''blue''>可选值：</font></b><br>[Normal: <font color=''green''>普通账号</font>]<br>[Super:
        <font color=''green''>高权限账号</font>]'
      en: 'Database account type, <b><font color=''blue''>AllowedValues: </font></b><br>[Normal:
        <font color=''green''>Ordinary account</font>]<br>[Super: <font color=''green''>High-privilege
        account</font>]'
    Default: Super
    AllowedValues:
    - Super
    - Normal
  RdsUserPassword:
    Type: String
    Label:
      zh-cn: 账号密码
      en: RDS Password
    Description:
      zh-cn: 大/小写字母、数字、特殊字符占三种，长度8－32位；特殊字符包含!@#$%^&*()_+-=
      en: 'Large/lowercase letters, Numbers and special characters take up three kinds,
        and the length is 8-32 bits. Special characters included! @ # $% ^ & * ()
        _ + - ='
    ConstraintDescription:
      zh-cn: 大/小写字母、数字、特殊字符占三种，长度8－32位；特殊字符包含!@#$%^&*()_+-=
      en: 'Large/lowercase letters, Numbers and special characters take up three kinds,
        and the length is 8-32 bits. Special characters included! @ # $% ^ & * ()
        _ + - ='
    MinLength: 8
    MaxLength: 32
    NoEcho: true
  PublicIP:
    Type: Boolean
    Label:
      zh-cn: 分配公网IP
      en: Allocate Public IP
    Description:
      en: Whether distribution PublicIP
      zh-cn: 是否分配公网IP
    Default: true
Resources:
  EcsVpc:
    Type: ALIYUN::ECS::VPC
    Properties:
      CidrBlock:
        Ref: CidrBlock
      VpcName:
        Fn::Join:
        - '-'
        - - StackId
          - Ref: ALIYUN::StackId
    Metadata:
      ALIYUN::ROS::Designer:
        id: 2b70f14b-74e2-4bfe-8443-06dfd4219dbc
  EcsVSwitch:
    Type: ALIYUN::ECS::VSwitch
    Properties:
      ZoneId:
        Ref: ZoneId
      VpcId:
        Ref: EcsVpc
      CidrBlock:
        Ref: VswCidrBlock
      VSwitchName:
        Fn::Join:
        - '-'
        - - StackId
          - Ref: ALIYUN::StackId
    Metadata:
      ALIYUN::ROS::Designer:
        id: 928b2c5f-365c-4eb7-855a-12a45e5f9f3d
  EcsSecurityGroup:
    Type: ALIYUN::ECS::SecurityGroup
    Properties:
      VpcId:
        Ref: EcsVpc
      SecurityGroupName:
        Fn::Sub: RosStack-${ALIYUN::StackName}
      SecurityGroupIngress:
      - PortRange: -1/-1
        Priority: 1
        SourceCidrIp: 0.0.0.0/0
        IpProtocol: all
        NicType: internet
      SecurityGroupEgress:
      - PortRange: -1/-1
        Priority: 1
        IpProtocol: all
        DestCidrIp: 0.0.0.0/0
        NicType: intranet
    Metadata:
      ALIYUN::ROS::Designer:
        id: 9382c21e-3a66-4e11-aad4-ffb1772f9c58
  EcsInstanceGroup:
    Type: ALIYUN::ECS::InstanceGroup
    Properties:
      ZoneId:
        Ref: ZoneId
      VpcId:
        Ref: EcsVpc
      VSwitchId:
        Ref: EcsVSwitch
      SecurityGroupId:
        Ref: EcsSecurityGroup
      ImageId:
        Ref: ImageId
      Tags:
      - Key: best_practice
        Value: '005 '
      IoOptimized: optimized
      DiskMappings:
      - Category:
          Ref: DiskCategory
        Size:
          Ref: DiskSize
      UserData:
        Fn::Join:
        - ''
        - - '#!/bin/sh

            '
          - 'yum -y install httpd

            '
          - 'systemctl start httpd

            '
          - 'yum install -y mysql

            '
      SystemDiskCategory:
        Ref: SystemDiskCategory
      SystemDiskSize:
        Ref: SystemDiskSize
      MaxAmount:
        Ref: ECSAmount
      InstanceName:
        Fn::Join:
        - ''
        - - Ref: InstanceNamePrefix
          - '[1,3]'
      HostName:
        Fn::Join:
        - ''
        - - Ref: HostNamePrefix
          - '[1,3]'
      MinAmount:
        Ref: ECSAmount
      AllocatePublicIP:
        Ref: PublicIP
      InstanceType:
        Ref: InstanceType
      Password:
        Ref: LoginPassword
    Metadata:
      ALIYUN::ROS::Designer:
        id: 8e35afe6-2dba-40bb-a350-822f9230a869
  SlbLoadBalancer:
    Type: ALIYUN::SLB::LoadBalancer
    Properties:
      Tags:
      - Key: best_practice
        Value: '005 '
      LoadBalancerName:
        Ref: LoadBalancerName
      PayType:
        Ref: PayType
      AddressType:
        Ref: AddressType
      MasterZoneId:
        Ref: ZoneId
      InternetChargeType:
        Ref: SLB_InternetChargeType
      LoadBalancerSpec:
        Ref: LoadBalancerSpec
    Metadata:
      ALIYUN::ROS::Designer:
        id: dfa453ed-c50e-4a49-b9b0-22d76bc4047a
  SlbListener:
    Type: ALIYUN::SLB::Listener
    Properties:
      ListenerPort:
        Ref: ListenerPort
      Bandwidth: -1
      LoadBalancerId:
        Fn::GetAtt:
        - SlbLoadBalancer
        - LoadBalancerId
      Protocol:
        Ref: Protocol
      BackendServerPort:
        Ref: SLBBackendServerPort
    Metadata:
      ALIYUN::ROS::Designer:
        id: 55505d3b-ab9c-4d07-8e5f-d0018aa644ef
  SlbBackendServerAttachment:
    Type: ALIYUN::SLB::BackendServerAttachment
    Properties:
      BackendServerList:
        Fn::GetAtt:
        - EcsInstanceGroup
        - InstanceIds
      LoadBalancerId:
        Fn::GetAtt:
        - SlbLoadBalancer
        - LoadBalancerId
    DependsOn: EcsInstanceGroup
    Metadata:
      ALIYUN::ROS::Designer:
        id: 47fbafff-a71f-4b37-a6ac-c702884a372c
  Rds:
    Type: ALIYUN::RDS::DBInstance
    Properties:
      VpcId:
        Ref: EcsVpc
      VSwitchId:
        Ref: EcsVSwitch
      DBInstanceClass:
        Ref: DBInstanceClass
      Engine:
        Fn::Select:
        - '0'
        - Fn::Split:
          - '-'
          - Ref: DBInstanceEngineAndVersion
      EngineVersion:
        Fn::Select:
        - '1'
        - Fn::Split:
          - '-'
          - Ref: DBInstanceEngineAndVersion
      MultiAZ: true
      DBMappings:
      - CharacterSetName: utf8
        DBName:
          Ref: DBName
      Tags:
        Key: best_practice
        Value: '005 '
      DBInstanceStorage:
        Ref: DBInstanceStorage
      SecurityIPList:
        Ref: CidrBlock
    Metadata:
      ALIYUN::ROS::Designer:
        id: 97fd9b05-583d-4f89-9ab7-8446413394ae
  RdsReadOnlyInstance1:
    Type: ALIYUN::RDS::ReadOnlyDBInstance
    Properties:
      ZoneId:
        Ref: ZoneId
      VPCId:
        Ref: EcsVpc
      VSwitchId:
        Ref: EcsVSwitch
      EngineVersion:
        Fn::Select:
        - '1'
        - Fn::Split:
          - '-'
          - Ref: DBInstanceEngineAndVersion
      DBInstanceId:
        Ref: Rds
      DBInstanceStorage:
        Ref: DBInstanceStorage
      DBInstanceClass:
        Ref: DBInstanceClass
    DependsOn: Rds
    Metadata:
      ALIYUN::ROS::Designer:
        id: 59cfa484-a841-43cd-964e-a16753a3e65c
  RdsReadOnlyInstance2:
    Type: ALIYUN::RDS::ReadOnlyDBInstance
    Properties:
      ZoneId:
        Ref: ZoneId
      VPCId:
        Ref: EcsVpc
      VSwitchId:
        Ref: EcsVSwitch
      EngineVersion:
        Fn::Select:
        - '1'
        - Fn::Split:
          - '-'
          - Ref: DBInstanceEngineAndVersion
      DBInstanceId:
        Ref: Rds
      DBInstanceStorage:
        Ref: DBInstanceStorage
      DBInstanceClass:
        Ref: DBInstanceClass
    DependsOn: Rds
    Metadata:
      ALIYUN::ROS::Designer:
        id: 857dbcb9-4cd8-45f5-8a38-882b076ea35c
  RdsAccount:
    Type: ALIYUN::RDS::Account
    Properties:
      DBInstanceId:
        Ref: Rds
      AccountType:
        Ref: RdsUserType
      AccountName:
        Ref: RdsUserName
      AccountPassword:
        Ref: RdsUserPassword
    DependsOn: RdsReadOnlyInstance2
    Metadata:
      ALIYUN::ROS::Designer:
        id: 1d28fbc8-4ddd-48b2-b3db-5f467f558197
Outputs:
  SlbIpAddress:
    Value:
      Fn::GetAtt:
      - SlbLoadBalancer
      - IpAddress
  EcsPublicIps:
    Value:
      Fn::GetAtt:
      - EcsInstanceGroup
      - PublicIps
  RdsPublicConnectionString:
    Value:
      Fn::GetAtt:
      - Rds
      - PublicConnectionString
  RdsPublicPort:
    Value:
      Fn::GetAtt:
      - Rds
      - PublicPort
  RdsReadOnlyInstance1ConnectionString:
    Value:
      Fn::GetAtt:
      - RdsReadOnlyInstance1
      - ConnectionString
  RdsReadOnlyInstance1Port:
    Value:
      Fn::GetAtt:
      - RdsReadOnlyInstance1
      - Port
  RdsReadOnlyInstance2ConnectionString:
    Value:
      Fn::GetAtt:
      - RdsReadOnlyInstance2
      - ConnectionString
  RdsReadOnlyInstance2Port:
    Value:
      Fn::GetAtt:
      - RdsReadOnlyInstance2
      - Port
  RdsAccountName:
    Value:
      Fn::GetAtt:
      - RdsAccount
      - AccountName
Metadata:
  ALIYUN::ROS::Interface:
    ParameterGroups:
    - Parameters:
      - CidrBlock
      - VswCidrBlock
      - ZoneId
      Label:
        default: VPC
    - Parameters:
      - ImageId
      - InstanceType
      - LoginPassword
      - ECSAmount
      - DiskSize
      - DiskCategory
      - SystemDiskSize
      - SystemDiskCategory
      - InstanceNamePrefix
      - HostNamePrefix
      Label:
        default: ECS
    - Parameters:
      - PayType
      - AddressType
      - SLB_InternetChargeType
      - LoadBalancerSpec
      - LoadBalancerName
      - Protocol
      - ListenerPort
      - SLBBackendServerPort
      Label:
        default: SLB
    - Parameters:
      - DBInstanceEngineAndVersion
      - DBInstanceClass
      - DBInstanceStorage
      - DBName
      - RdsUserName
      - RdsUserType
      - RdsUserPassword
      Label:
        default: RDS
    TemplateTags:
    - 中小型公司交易系统数据零丢失最佳实践 - 云上环境部署
  ALIYUN::ROS::Designer:
    2b70f14b-74e2-4bfe-8443-06dfd4219dbc:
      size:
        width: 481.0537109375
        height: 481
      position:
        x: 183
        y: 77
      z: 0
      embeds:
      - 928b2c5f-365c-4eb7-855a-12a45e5f9f3d
      - 9382c21e-3a66-4e11-aad4-ffb1772f9c58
    928b2c5f-365c-4eb7-855a-12a45e5f9f3d:
      size:
        width: 397
        height: 324
      position:
        x: 224
        y: 117
      z: 1
      embeds:
      - 8e35afe6-2dba-40bb-a350-822f9230a869
      - 97fd9b05-583d-4f89-9ab7-8446413394ae
      - 59cfa484-a841-43cd-964e-a16753a3e65c
      - 857dbcb9-4cd8-45f5-8a38-882b076ea35c
    9382c21e-3a66-4e11-aad4-ffb1772f9c58:
      size:
        width: 60
        height: 60
      position:
        x: 287
        y: 457
      z: 1
    8e35afe6-2dba-40bb-a350-822f9230a869:
      size:
        width: 60
        height: 60
      position:
        x: 287
        y: 251
      z: 2
    55505d3b-ab9c-4d07-8e5f-d0018aa644ef:
      size:
        width: 60
        height: 60
      position:
        x: 65
        y: 452
      z: 0
    dfa453ed-c50e-4a49-b9b0-22d76bc4047a:
      size:
        width: 60
        height: 60
      position:
        x: 65
        y: 355
      z: 0
    47fbafff-a71f-4b37-a6ac-c702884a372c:
      size:
        width: 60
        height: 60
      position:
        x: 65
        y: 251
      z: 0
    97fd9b05-583d-4f89-9ab7-8446413394ae:
      size:
        width: 60
        height: 60
      position:
        x: 446
        y: 189
      z: 2
    59cfa484-a841-43cd-964e-a16753a3e65c:
      size:
        width: 60
        height: 60
      position:
        x: 518
        y: 307
      z: 2
    857dbcb9-4cd8-45f5-8a38-882b076ea35c:
      size:
        width: 60
        height: 60
      position:
        x: 377
        y: 307
      z: 2
    1d28fbc8-4ddd-48b2-b3db-5f467f558197:
      size:
        width: 60
        height: 60
      position:
        x: 446
        y: 10
      z: 0
    a7323ec2-3782-4924-8b3b-67ee6d569bb8:
      source:
        id: 8e35afe6-2dba-40bb-a350-822f9230a869
      target:
        id: 9382c21e-3a66-4e11-aad4-ffb1772f9c58
      z: 1
    63874fc2-0433-4e01-a3ba-9e2423b96a3c:
      source:
        id: 55505d3b-ab9c-4d07-8e5f-d0018aa644ef
      target:
        id: dfa453ed-c50e-4a49-b9b0-22d76bc4047a
      z: 1
    6b24ae1e-e95a-44ef-a6a3-3b4049c3ee3e:
      source:
        id: 47fbafff-a71f-4b37-a6ac-c702884a372c
      target:
        id: 8e35afe6-2dba-40bb-a350-822f9230a869
      z: 1
    decd2481-c9fc-4b96-abed-6fdfac244edd:
      source:
        id: 47fbafff-a71f-4b37-a6ac-c702884a372c
      target:
        id: dfa453ed-c50e-4a49-b9b0-22d76bc4047a
      z: 1
    81f13b19-befb-46a8-973b-c96d83c0e5cf:
      source:
        id: 59cfa484-a841-43cd-964e-a16753a3e65c
      target:
        id: 97fd9b05-583d-4f89-9ab7-8446413394ae
      z: 1
    85902be2-f1f2-4ba5-9fd4-c1e842ca6ec2:
      source:
        id: 857dbcb9-4cd8-45f5-8a38-882b076ea35c
      target:
        id: 97fd9b05-583d-4f89-9ab7-8446413394ae
      z: 1
    a49220bb-1b99-404c-aed1-d1686818beda:
      source:
        id: 1d28fbc8-4ddd-48b2-b3db-5f467f558197
      target:
        id: 97fd9b05-583d-4f89-9ab7-8446413394ae
      z: 1
